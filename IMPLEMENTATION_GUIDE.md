# 彩票开奖数据分析和预测系统 - 完整实现指南\n\n## 项目概述\n\n本系统是一个实时彩票开奖数据分析和预测平台，集成了九层精筛算法、AI 四维评分、L6 命中率统计等功能。系统每分钟自动同步最新开奖数据，执行完整的筛选逻辑，并将结果推送到 GitHub。\n\n## 已完成的工作\n\n### 1. 数据库设计 ✓\n\n已创建 4 个核心表：\n- `lottery_draws` - 开奖号码记录\n- `lottery_scores` - 号码四维评分\n- `l6_statistics` - L6 命中统计\n- `layer_results` - 各层筛选结果缓存\n\n### 2. 核心算法模块 ✓\n\n文件：`server/lottery-algorithm.ts`\n- `extractLastThreeDigits()` - 从四位数提取后三位\n- `analyzeHistoryData()` - 分析历史数据计算热码、冷码、Key码\n- `calculateScores()` - AI 四维评分（和值、跨度、冷热码、理论命中率）\n- `performNineLayerFiltering()` - 完整九层筛选（L9→L1）\n- `testL6Hit()` - 测试开奖号码是否命中 L6\n\n### 3. 数据库查询函数 ✓\n\n文件：`server/db.ts` 中已添加：\n- `getLatestDraws()` - 获取最近 N 期开奖\n- `saveLotteryScores()` - 保存号码评分\n- `saveL6Statistic()` - 保存 L6 命中记录\n- `getL6HitRate()` - 获取 L6 命中率\n- `saveLayerResults()` - 保存层级结果\n- `getLayerResults()` - 获取层级结果\n\n## 待完成的工作\n\n### 1. 后端 tRPC 接口\n\n需要创建文件：`server/routers/lottery.ts`\n\n```typescript\nexport const lotteryRouter = router({\n  // 获取最新开奖数据\n  fetchLatestData: publicProcedure.query(async () => { ... }),\n  \n  // 获取最近 10 期开奖\n  getLatestDraws: publicProcedure.query(async () => { ... }),\n  \n  // 分析历史数据并执行九层筛选\n  analyzeAndScore: publicProcedure.query(async () => { ... }),\n  \n  // 测试开奖号码是否命中 L6\n  testL6Hit: publicProcedure.input(z.object({ drawNumber: z.string() })).mutation(async ({ input }) => { ... }),\n  \n  // 获取 L6 命中统计\n  getL6Statistics: publicProcedure.query(async () => { ... }),\n  \n  // 获取指定层级的筛选结果\n  getLayerResults: publicProcedure.input(z.object({ layerId: z.string() })).query(async ({ input }) => { ... }),\n  \n  // 获取所有层级信息\n  getLayers: publicProcedure.query(async () => { ... }),\n  \n  // 推送结果到 GitHub\n  pushToGitHub: publicProcedure.input(z.object({ ... })).mutation(async ({ input }) => { ... }),\n});\n```\n\n### 2. 前端 React 页面\n\n需要创建文件：`client/src/pages/Lottery.tsx`\n\n主要组件：\n1. **实时开奖数据面板** - 显示前 10 期开奖号码\n2. **热码冷码分析面板** - 展示热码、冷码、Key码\n3. **L6 命中统计面板** - 总测试次数、命中次数、命中率、最近 10 次记录\n4. **九层筛选管道** - L9→L1 按钮，显示各层数量\n5. **层级详情面板** - 组合数量、保留比例、平均评分、号码覆盖率\n6. **组合展示区域** - 网格显示各层的筛选结果\n7. **详细分析面板** - 四维评分分布、组合特征统计\n\n### 3. 自动化集成\n\n在 `client/src/pages/Lottery.tsx` 中实现：\n```typescript\nuseEffect(() => {\n  // 页面加载时执行一次\n  const performAnalysis = async () => {\n    await trpc.lottery.analyzeAndScore.query();\n  };\n  performAnalysis();\n  \n  // 每分钟执行一次\n  const interval = setInterval(performAnalysis, 60000);\n  return () => clearInterval(interval);\n}, []);\n```\n\n## 快速实现步骤\n\n### Step 1: 创建 tRPC 路由\n\n在 `server/routers/lottery.ts` 中实现上述接口。参考已有的 `server/lottery-algorithm.ts` 和 `server/db.ts`。\n\n### Step 2: 更新主路由器\n\n在 `server/routers.ts` 中添加：\n```typescript\nimport { lotteryRouter } from \"./routers/lottery\";\n\nexport const appRouter = router({\n  // ... existing routers\n  lottery: lotteryRouter,\n});\n```\n\n### Step 3: 创建前端页面\n\n在 `client/src/pages/Lottery.tsx` 中：\n1. 使用 `trpc.lottery.fetchLatestData.useQuery()` 获取最新开奖\n2. 使用 `trpc.lottery.analyzeAndScore.useQuery()` 执行分析\n3. 使用 `trpc.lottery.getL6Statistics.useQuery()` 获取命中统计\n4. 使用 `trpc.lottery.getLayerResults.useQuery()` 获取层级结果\n\n### Step 4: 更新导航\n\n在 `client/src/App.tsx` 中添加路由：\n```typescript\n<Route path=\"/lottery\" component={Lottery} />\n```\n\n### Step 5: 测试和验证\n\n1. 运行 `pnpm dev` 启动开发服务器\n2. 访问 `/lottery` 页面\n3. 验证数据采集、分析、L6 命中测试功能\n\n## 代码参考\n\n### 算法模块已实现的函数\n\n```typescript\n// 提取后三位\nexport function extractLastThreeDigits(fourDigitStr: string): string\n\n// 分析历史数据\nexport function analyzeHistoryData(\n  draws: Array<{ number: string }>,\n  keyCodeCount?: number\n): { hotDigits, coldDigits, keyCodes, codeFreq }\n\n// 计算四维评分\nexport function calculateScores(\n  hotDigits: number[],\n  coldDigits: number[],\n  keyCodes: number[],\n  codeFreq: Record<number, number>\n): Record<string, ScoredNumber>\n\n// 九层筛选\nexport function performNineLayerFiltering(\n  scoredNumbers: Record<string, ScoredNumber>,\n  hotDigits: number[],\n  keyCodes: number[]\n): Record<string, ScoredNumber[]>\n\n// L6 命中测试\nexport function testL6Hit(\n  drawNumber: string,\n  l6Results: ScoredNumber[]\n): boolean\n```\n\n## 界面设计规范\n\n### 色彩方案（赛博朋克风格）\n- 背景：深蓝渐变 `linear-gradient(135deg, #0a0f1c 0%, #1a1f35 100%)`\n- 主色：霓虹蓝 `#60a5fa`\n- 辅色：霓虹紫 `#a78bfa`、霓虹橙 `#fbbf24`\n- 玻璃拟态：`background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px);`\n\n### 数据展示\n- 预测号码：红色大字体 `text-red-500 text-2xl font-bold`\n- 命中状态：绿色表示命中，灰色表示未命中\n- 进度条：蓝紫渐变 `linear-gradient(90deg, #3b82f6, #8b5cf6)`\n\n## 部署注意事项\n\n1. **环境变量**：确保 `DATABASE_URL` 已正确配置\n2. **GitHub 集成**：实现 `pushToGitHub()` 需要 GitHub API 令牌\n3. **数据库迁移**：已通过 `pnpm db:push` 完成\n4. **依赖安装**：所有必要的 npm 包已在 `package.json` 中\n\n## 故障排除\n\n### 数据采集失败\n- 检查 API 地址 `https://myip.xigoodone.workers.dev` 是否可访问\n- 确认网络连接\n\n### 数据库错误\n- 检查 `DATABASE_URL` 连接字符串\n- 确认所有表已创建（运行 `pnpm db:push`）\n\n### 前端不显示数据\n- 检查浏览器控制台是否有错误\n- 确认 tRPC 接口已正确实现\n- 验证数据库中有数据\n\n## 下一步优化\n\n1. **实时 WebSocket 更新** - 使用 Socket.io 实现实时推送\n2. **GitHub 自动推送** - 完整实现 GitHub API 集成\n3. **数据可视化** - 添加图表展示命中率趋势\n4. **用户认证** - 添加用户登录和权限管理\n5. **性能优化** - 缓存层级结果，减少重复计算\n\n## 联系和支持\n\n如有问题，请参考项目中的注释和文档。所有核心算法已充分测试，可直接使用。\n"
